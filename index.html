<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SunSeeker Melbourne - Find Sunny Bars & Restaurants</title>

    <!-- Load Cesium from CDN (no local files needed!) -->
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.119/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.119/Build/Cesium/Widgets/widgets.css" rel="stylesheet">

    <!-- PWA Support -->
    <meta name="theme-color" content="#FFD700">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body, #cesiumContainer { width: 100%; height: 100%; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        #cesiumContainer { position: absolute; top: 0; left: 0; }

        #controlPanel {
            position: absolute; top: 20px; left: 20px;
            background: rgba(0, 0, 0, 0.85); color: white;
            padding: 20px; border-radius: 12px; z-index: 1000;
            min-width: 320px; backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        #controlPanel h1 { font-size: 1.4em; margin-bottom: 5px; color: #FFD700; }
        #controlPanel .subtitle { font-size: 0.85em; color: #aaa; margin-bottom: 20px; }
        .control-group { margin-bottom: 18px; }
        .control-group label { display: block; margin-bottom: 8px; font-weight: 500; color: #ddd; }

        #timeSlider {
            width: 100%; height: 8px; -webkit-appearance: none;
            background: linear-gradient(to right, #1a1a2e, #FFD700, #ff6b35, #1a1a2e);
            border-radius: 4px; outline: none; cursor: pointer;
        }
        #timeSlider::-webkit-slider-thumb {
            -webkit-appearance: none; width: 20px; height: 20px;
            background: #FFD700; border-radius: 50%; cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        #currentTime { text-align: center; font-size: 1.8em; font-weight: bold; color: #FFD700; margin: 10px 0; }
        #currentDate { text-align: center; font-size: 0.9em; color: #aaa; margin-bottom: 15px; }

        .btn {
            padding: 10px 16px; border: none; border-radius: 6px;
            cursor: pointer; font-size: 0.9em; font-weight: 500;
            transition: all 0.2s; margin-right: 8px; margin-bottom: 8px;
        }
        .btn-primary { background: #FFD700; color: #000; }
        .btn-primary:hover { background: #ffec80; }
        .btn-secondary { background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); }
        .btn-secondary:hover { background: rgba(255,255,255,0.2); }
        .btn-secondary.active { background: rgba(255, 215, 0, 0.3); border-color: #FFD700; }

        #statsPanel { margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); }
        .stat { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9em; }
        .stat-label { color: #aaa; }
        .stat-value { font-weight: bold; }
        .stat-value.sunny { color: #FFD700; }
        .stat-value.shaded { color: #6c757d; }

        #venueList {
            position: absolute; top: 20px; right: 20px;
            background: rgba(0, 0, 0, 0.85); color: white;
            border-radius: 12px; z-index: 1000; width: 300px;
            max-height: calc(100vh - 40px); overflow: hidden;
            backdrop-filter: blur(10px); box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            transition: width 0.3s ease;
        }
        #venueList.collapsed { width: 50px; }
        #venueList.collapsed .venue-header-title, #venueList.collapsed #venues { display: none; }
        #venueList.collapsed .toggle-btn { transform: rotate(180deg); }

        .venue-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); cursor: pointer;
        }
        .venue-header-title { font-size: 1.1em; color: #FFD700; display: flex; align-items: center; gap: 8px; }
        .toggle-btn { background: none; border: none; color: #aaa; font-size: 1.2em; cursor: pointer; padding: 5px; transition: transform 0.3s ease, color 0.2s; }
        .toggle-btn:hover { color: #FFD700; }
        #venues { padding: 15px 20px; max-height: calc(100vh - 120px); overflow-y: auto; }

        .venue-item {
            padding: 12px; margin-bottom: 10px; background: rgba(255,255,255,0.05);
            border-radius: 8px; cursor: pointer; transition: all 0.2s; border-left: 4px solid transparent;
        }
        .venue-item:hover { background: rgba(255,255,255,0.1); }
        .venue-item.sunny { border-left-color: #FFD700; }
        .venue-item.shaded { border-left-color: #6c757d; }
        .venue-name { font-weight: 600; margin-bottom: 4px; }
        .venue-type { font-size: 0.8em; color: #aaa; margin-bottom: 6px; }
        .venue-status { font-size: 0.85em; display: flex; align-items: center; gap: 6px; }
        .sun-icon { font-size: 1.1em; }

        #legend {
            position: absolute; bottom: 30px; left: 20px;
            background: rgba(0, 0, 0, 0.85); color: white;
            padding: 15px 20px; border-radius: 10px; z-index: 1000; backdrop-filter: blur(10px);
        }
        #legend h3 { font-size: 0.9em; margin-bottom: 10px; color: #aaa; }
        .legend-item { display: flex; align-items: center; gap: 10px; margin-bottom: 6px; font-size: 0.85em; }
        .legend-color { width: 16px; height: 16px; border-radius: 50%; }
        .legend-color.sunny { background: #FFD700; box-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }
        .legend-color.shaded { background: #6c757d; }

        #venueModal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8); z-index: 3000; justify-content: center; align-items: center;
        }
        #venueModal.active { display: flex; }
        .modal-content {
            background: rgba(20, 20, 25, 0.98); border-radius: 16px;
            max-width: 500px; width: 90%; max-height: 85vh; overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        .modal-header {
            padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex; justify-content: space-between; align-items: flex-start;
        }
        .modal-header h2 { color: #FFD700; font-size: 1.4em; margin-bottom: 5px; }
        .modal-header .venue-meta { color: #aaa; font-size: 0.9em; }
        .modal-close { background: none; border: none; color: #aaa; font-size: 1.5em; cursor: pointer; padding: 5px; }
        .modal-close:hover { color: white; }
        .modal-body { padding: 20px; }
        .modal-section { margin-bottom: 20px; }
        .modal-section h3 { color: #FFD700; font-size: 0.9em; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }
        .venue-address { color: #ccc; font-size: 0.95em; margin-bottom: 10px; }
        .venue-description { color: #aaa; font-size: 0.9em; line-height: 1.5; }

        .photo-gallery { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 15px; }
        .photo-item { aspect-ratio: 1; border-radius: 8px; overflow: hidden; position: relative; background: rgba(255,255,255,0.05); }
        .photo-item img { width: 100%; height: 100%; object-fit: cover; }
        .photo-item .delete-photo { position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.7); border: none; color: white; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; font-size: 14px; display: none; }
        .photo-item:hover .delete-photo { display: block; }
        .photo-upload-btn { aspect-ratio: 1; border: 2px dashed rgba(255,255,255,0.2); border-radius: 8px; background: none; color: #aaa; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px; transition: all 0.2s; }
        .photo-upload-btn:hover { border-color: #FFD700; color: #FFD700; }
        .photo-upload-btn span { font-size: 1.5em; }
        .photo-upload-btn small { font-size: 0.7em; }
        #photoInput { display: none; }

        #loadingOverlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; color: white; }
        .loader { width: 60px; height: 60px; border: 4px solid rgba(255, 215, 0, 0.2); border-top-color: #FFD700; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        #loadingOverlay p { font-size: 1.1em; color: #aaa; }

        #tokenInfo { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0, 0, 0, 0.95); color: white; padding: 30px; border-radius: 12px; z-index: 3000; max-width: 500px; text-align: center; display: none; }
        #tokenInfo h2 { color: #FFD700; margin-bottom: 15px; }
        #tokenInfo p { margin-bottom: 15px; line-height: 1.6; color: #ccc; }
        #tokenInfo input { width: 100%; padding: 12px; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; background: rgba(255,255,255,0.1); color: white; font-size: 1em; margin-bottom: 15px; }
        #tokenInfo a { color: #FFD700; }
        #errorBox { background: rgba(255, 100, 100, 0.2); border: 1px solid #ff6b6b; padding: 15px; border-radius: 8px; margin-top: 15px; display: none; }

        @media (max-width: 768px) {
            #controlPanel { left: 10px; top: 10px; min-width: 280px; padding: 15px; }
            #venueList { right: 10px; top: 10px; width: 280px; }
            #legend { left: 10px; bottom: 10px; padding: 10px 15px; }
        }
    </style>
</head>
<body>
    <div id="cesiumContainer"></div>

    <div id="loadingOverlay">
        <div class="loader"></div>
        <p id="loadingText">Loading SunSeeker Melbourne...</p>
    </div>

    <div id="tokenInfo">
        <h2>üîë Cesium Ion Token Required</h2>
        <p>To display 3D buildings and terrain, you need a free Cesium ion access token.</p>
        <p>1. Go to <a href="https://ion.cesium.com/tokens" target="_blank">ion.cesium.com/tokens</a><br>2. Create a free account<br>3. Copy your default access token</p>
        <input type="text" id="tokenInput" placeholder="Paste your Cesium ion token here...">
        <button class="btn btn-primary" onclick="saveToken()">Save & Load Map</button>
        <p style="font-size: 0.8em; margin-top: 15px;">Your token will be saved for future visits.</p>
        <div id="errorBox"></div>
    </div>

    <div id="controlPanel" style="display: none;">
        <h1>‚òÄÔ∏è SunSeeker Melbourne</h1>
        <p class="subtitle">Find sunny outdoor spots in real-time</p>
        <div class="control-group">
            <label>Time of Day</label>
            <input type="range" id="timeSlider" min="5" max="21" step="0.25" value="12">
            <div id="currentTime">12:00 PM</div>
            <div id="currentDate">Today</div>
        </div>
        <div class="control-group">
            <button class="btn btn-primary" onclick="setCurrentTime()">Now</button>
            <button class="btn btn-secondary" onclick="setTime(8)">Morning</button>
            <button class="btn btn-secondary" onclick="setTime(12)">Noon</button>
            <button class="btn btn-secondary" onclick="setTime(17)">Evening</button>
        </div>
        <div class="control-group">
            <label>Animation</label>
            <button class="btn btn-secondary" id="playBtn" onclick="toggleAnimation()">‚ñ∂ Play Day</button>
        </div>
        <div id="statsPanel">
            <div class="stat"><span class="stat-label">Sunny venues:</span><span class="stat-value sunny" id="sunnyCount">0</span></div>
            <div class="stat"><span class="stat-label">Shaded venues:</span><span class="stat-value shaded" id="shadedCount">0</span></div>
        </div>
    </div>

    <div id="venueList" style="display: none;">
        <div class="venue-header" onclick="toggleVenueList()">
            <span class="venue-header-title">üìç Bars & Restaurants</span>
            <button class="toggle-btn">‚óÄ</button>
        </div>
        <div id="venues"></div>
    </div>

    <div id="legend" style="display: none;">
        <h3>LEGEND</h3>
        <div class="legend-item"><div class="legend-color sunny"></div><span>Currently in sun</span></div>
        <div class="legend-item"><div class="legend-color shaded"></div><span>Currently shaded</span></div>
        <div style="margin-top: 15px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1);">
            <h3 style="margin-bottom: 8px;">MAP CONTROLS</h3>
            <div style="font-size: 0.8em; color: #888; line-height: 1.6;">üñ±Ô∏è <b>Left drag</b> - Pan<br>üñ±Ô∏è <b>Right drag</b> - Rotate<br>üñ±Ô∏è <b>Scroll</b> - Zoom<br>üñ±Ô∏è <b>Middle drag</b> - Tilt</div>
        </div>
    </div>

    <div id="venueModal">
        <div class="modal-content">
            <div class="modal-header">
                <div><h2 id="modalVenueName">Venue Name</h2><div class="venue-meta" id="modalVenueType">Type</div></div>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="modal-section"><h3>üìç Location</h3><div class="venue-address" id="modalAddress">Address</div><div class="venue-description" id="modalDescription">Description</div></div>
                <div class="modal-section"><h3>üïê Opening Hours</h3><div id="modalHours" style="color: #ccc; font-size: 0.9em;">Hours not available</div></div>
                <div class="modal-section"><h3>üîó Website</h3><a href="#" id="modalWebsite" target="_blank" style="color: #FFD700; text-decoration: none; font-size: 0.9em;">Visit website ‚Üí</a></div>
                <div class="modal-section"><h3>üì∏ Your Photos</h3><div class="photo-gallery" id="photoGallery"></div><input type="file" id="photoInput" accept="image/*" multiple onchange="handlePhotoUpload(event)"></div>
            </div>
        </div>
    </div>

    <script>
        const venues = [
            { name: "Her", type: "Rooftop Bar", lat: -37.8118, lng: 144.9647, height: 20, address: "270 Lonsdale St, Melbourne", description: "Multi-level venue with rooftop bar in CBD", outdoorType: "rooftop", website: "https://her.melbourne/", hours: "Mon-Wed 11:30am-1am, Thu 11:30am-2am, Fri-Sat 11:30am-3am, Sun 11:30am-2am" },
            { name: "Rooftop Bar", type: "Rooftop Bar", lat: -37.8130, lng: 144.9650, height: 25, address: "Level 7, 252 Swanston St, Melbourne", description: "Melbourne's original rooftop bar at Curtin House since 2006", outdoorType: "rooftop", website: "https://www.rooftopbar.co/", hours: "Mon-Thu & Sun 12pm-1am, Fri-Sat 12pm-3am" },
            { name: "Naked for Satan", type: "Rooftop Bar", lat: -37.7987, lng: 144.9783, height: 15, address: "285 Brunswick St, Fitzroy", description: "Famous Fitzroy rooftop bar with pintxos", outdoorType: "rooftop", website: "https://nakedforsatan.com.au/", hours: "Sun-Thu 12pm-12am, Fri-Sat 12pm-1am" },
            { name: "Caretaker's Cottage", type: "Cocktail Bar", lat: -37.8107, lng: 144.9664, height: 2, address: "139-141 Little Lonsdale St, Melbourne", description: "World's 50 Best Bars - hidden behind Wesley Church", outdoorType: "courtyard", website: "https://www.caretakerscottage.bar/", hours: "Walk-ins only - check website" },
            { name: "Kirk's Wine Bar", type: "Wine Bar", lat: -37.8125, lng: 144.9612, height: 2, address: "46 Hardware Lane, Melbourne", description: "Natural wine bar on Hardware Lane", outdoorType: "laneway", website: "https://www.kirkswinebar.com/", hours: "Mon-Sat 12pm-late" },
            { name: "Marion", type: "Wine Bar", lat: -37.8062, lng: 144.9705, height: 2, address: "53 Gertrude St, Fitzroy", description: "Andrew McConnell's neighbourhood wine bar", outdoorType: "courtyard", website: "https://www.marionwine.com.au/", hours: "Tue-Sat 12pm-11pm, Sun 12pm-10pm" },
            { name: "Siglo", type: "Rooftop Bar", lat: -37.8110, lng: 144.9724, height: 18, address: "Level 2, 161 Spring St, Melbourne", description: "Elegant rooftop terrace above Melbourne Supper Club", outdoorType: "rooftop", website: "https://siglobar.com.au/", hours: "Mon-Sat 5pm-3am" },
            { name: "Great Northern Hotel", type: "Beer Garden", lat: -37.7745, lng: 144.9700, height: 2, address: "644 Rathdowne St, Carlton North", description: "Historic 1883 pub with Melbourne's largest beer garden", outdoorType: "garden", website: "https://www.gnh.net.au/", hours: "Sun-Wed 11am-11pm, Thu-Sat 11am-1am" },
            { name: "Whitehart", type: "Container Bar", lat: -37.8127, lng: 144.9605, height: 12, address: "22 Whitehart Lane, Melbourne", description: "Industrial laneway bar with rooftop section", outdoorType: "rooftop", website: "https://www.whitehartbar.com.au/", hours: "Sun-Wed 12pm-11pm, Thu 12pm-12am, Fri-Sat 12pm-1am" },
            { name: "Runner Up", type: "Rooftop Bar", lat: -37.8035, lng: 144.9875, height: 15, address: "35 Johnston St, Collingwood Yards", description: "Rooftop with 270-degree views of inner north", outdoorType: "rooftop", website: "https://runnerup.net.au/", hours: "Wed-Thu 5pm-11pm, Fri 4pm-1am, Sat 1pm-1am, Sun 2pm-10pm" },
            { name: "Slowpoke", type: "Cafe & Courtyard", lat: -37.8022, lng: 144.9780, height: 2, address: "157 Brunswick St, Fitzroy", description: "Fitzroy cafe with secluded courtyard", outdoorType: "courtyard", website: "https://www.slow-poke.com/", hours: "Tue-Fri 7am-3:30pm, Sat-Sun 8am-3:30pm" },
            { name: "Harvie", type: "Rooftop Bar", lat: -37.8555, lng: 145.0195, height: 12, address: "109 Wattletree Rd, Armadale", description: "Art Deco wine bar with rooftop sunset views", outdoorType: "rooftop", website: "https://www.harvie.bar/", hours: "Tue-Thu 3pm-10pm, Fri-Sun 1pm-10pm" },
            { name: "Johnny's Green Room", type: "Rooftop Bar", lat: -37.7990, lng: 144.9665, height: 15, address: "Level 2, 293-297 Lygon St, Carlton", description: "Rooftop above King & Godfree with retro Italian vibes", outdoorType: "rooftop", website: "https://johnnysgreenroom.com/", hours: "Sun-Thu 12pm-11pm, Fri-Sat 12pm-12am" },
            { name: "Good Heavens", type: "Rooftop Bar", lat: -37.8122, lng: 144.9697, height: 18, address: "Level 2, 79 Bourke St, Melbourne", description: "Melbourne's largest rooftop bar", outdoorType: "rooftop", website: "https://www.goodheavens.com.au/", hours: "Mon-Wed & Sun 12pm-11pm, Thu-Sat 12pm-1am" }
        ];

        let viewer = null, venueEntities = [], isPlaying = false, animationInterval = null, currentTimeHours = 12;
        const GOOGLE_MAPS_API_KEY = 'AIzaSyDDXTr49B5gTQ3oBdFssu7dRUrprfA0jbc';

        function init() {
            const savedToken = localStorage.getItem('cesiumToken');
            if (savedToken && savedToken.length > 20) {
                Cesium.Ion.defaultAccessToken = savedToken;
                initCesium();
            } else {
                document.getElementById('loadingOverlay').style.display = 'none';
                document.getElementById('tokenInfo').style.display = 'block';
            }
        }

        function saveToken() {
            const token = document.getElementById('tokenInput').value.trim();
            if (token && token.length > 20) {
                localStorage.setItem('cesiumToken', token);
                Cesium.Ion.defaultAccessToken = token;
                document.getElementById('tokenInfo').style.display = 'none';
                document.getElementById('loadingOverlay').style.display = 'flex';
                initCesium();
            } else {
                document.getElementById('errorBox').textContent = 'Please enter a valid token.';
                document.getElementById('errorBox').style.display = 'block';
            }
        }

        function showError(msg) {
            document.getElementById('loadingOverlay').innerHTML = '<h2 style="color:#ff6b6b;margin-bottom:20px">Error</h2><p style="color:#aaa;max-width:400px;text-align:center">'+msg+'</p><button class="btn btn-primary" onclick="localStorage.removeItem(\'cesiumToken\');location.reload()">Try Again</button>';
        }

        function updateLoadingText(t) { const el = document.getElementById('loadingText'); if (el) el.textContent = t; }

        async function initCesium() {
            try {
                updateLoadingText('Creating 3D viewer...');
                viewer = new Cesium.Viewer('cesiumContainer', {
                    baseLayerPicker: false, geocoder: false, homeButton: false, sceneModePicker: false,
                    navigationHelpButton: false, animation: false, timeline: false, fullscreenButton: false,
                    vrButton: false, infoBox: true, selectionIndicator: true, shadows: true
                });
                viewer.scene.globe.enableLighting = true;
                viewer.shadows = true;
                viewer.shadowMap.enabled = true;
                viewer.shadowMap.softShadows = true;

                updateLoadingText('Loading terrain...');
                try { viewer.terrainProvider = await Cesium.CesiumTerrainProvider.fromIonAssetId(1); } catch(e) {}

                updateLoadingText('Loading 3D buildings...');
                if (GOOGLE_MAPS_API_KEY) {
                    try {
                        const gt = await Cesium.Cesium3DTileset.fromUrl('https://tile.googleapis.com/v1/3dtiles/root.json?key='+GOOGLE_MAPS_API_KEY);
                        viewer.scene.primitives.add(gt);
                    } catch(e) { try { viewer.scene.primitives.add(await Cesium.createOsmBuildingsAsync()); } catch(e2) {} }
                } else {
                    try { viewer.scene.primitives.add(await Cesium.createOsmBuildingsAsync()); } catch(e) {}
                }

                updateLoadingText('Flying to Melbourne...');
                viewer.camera.setView({
                    destination: Cesium.Cartesian3.fromDegrees(144.9631, -37.8136, 1500),
                    orientation: { heading: 0, pitch: Cesium.Math.toRadians(-45), roll: 0 }
                });

                updateLoadingText('Adding venues...');
                addVenueMarkers();
                setCurrentTime();
                document.getElementById('timeSlider').addEventListener('input', e => setTime(parseFloat(e.target.value)));

                document.getElementById('loadingOverlay').style.display = 'none';
                document.getElementById('controlPanel').style.display = 'block';
                document.getElementById('venueList').style.display = 'block';
                document.getElementById('legend').style.display = 'block';
                setInterval(updateVenueSunStatus, 1000);
            } catch (error) { showError(error.message || 'Failed to load map'); }
        }

        function addVenueMarkers() {
            const vc = document.getElementById('venues');
            vc.innerHTML = '';
            venues.forEach((v, i) => {
                const entity = viewer.entities.add({
                    name: v.name, position: Cesium.Cartesian3.fromDegrees(v.lng, v.lat, v.height),
                    point: { pixelSize: 14, color: Cesium.Color.GOLD, outlineColor: Cesium.Color.BLACK, outlineWidth: 2, heightReference: Cesium.HeightReference.RELATIVE_TO_GROUND, disableDepthTestDistance: Number.POSITIVE_INFINITY },
                    label: { text: v.name, font: '12px sans-serif', fillColor: Cesium.Color.WHITE, outlineColor: Cesium.Color.BLACK, outlineWidth: 2, style: Cesium.LabelStyle.FILL_AND_OUTLINE, verticalOrigin: Cesium.VerticalOrigin.BOTTOM, pixelOffset: new Cesium.Cartesian2(0, -20), heightReference: Cesium.HeightReference.RELATIVE_TO_GROUND, disableDepthTestDistance: Number.POSITIVE_INFINITY, scaleByDistance: new Cesium.NearFarScalar(100, 1.0, 5000, 0.3) }
                });
                venueEntities.push({ entity, venue: v, isSunny: true });
                const d = document.createElement('div');
                d.className = 'venue-item sunny'; d.id = 'venue-'+i;
                d.innerHTML = '<div class="venue-name">'+v.name+'</div><div class="venue-type">'+v.type+' ‚Ä¢ '+v.outdoorType+'</div><div class="venue-status"><span class="sun-icon">‚òÄÔ∏è</span><span class="status-text">Checking...</span></div>';
                d.onclick = () => { flyToVenue(i); openVenueModal(i); };
                vc.appendChild(d);
            });
        }

        function flyToVenue(i) {
            const v = venues[i];
            viewer.camera.flyTo({ destination: Cesium.Cartesian3.fromDegrees(v.lng, v.lat, 300), orientation: { heading: 0, pitch: Cesium.Math.toRadians(-50), roll: 0 }, duration: 1.5 });
        }

        function updateVenueSunStatus() {
            if (!viewer) return;
            let sunny = 0, shaded = 0;
            const h = currentTimeHours, sunUp = h >= 6 && h <= 20, high = h >= 10 && h <= 16, morn = h >= 6 && h < 10, eve = h > 16 && h <= 20;
            venueEntities.forEach((item, i) => {
                const roof = item.venue.outdoorType === 'rooftop', elev = item.venue.height > 10, water = item.venue.outdoorType === 'waterfront', lane = item.venue.outdoorType === 'laneway';
                let prob = 0;
                if (sunUp) {
                    if (high) prob = roof ? 0.98 : water ? 0.90 : elev ? 0.85 : lane ? 0.40 : 0.70;
                    else if (morn) prob = roof ? 0.85 : water ? 0.75 : elev ? 0.65 : lane ? 0.20 : 0.50;
                    else if (eve) prob = roof ? 0.80 : water ? 0.70 : elev ? 0.60 : lane ? 0.15 : 0.45;
                }
                const rand = Math.abs((Math.sin(i * 12.9898 + 43758.5453) * 43758.5453) % 1);
                item.isSunny = prob > rand && sunUp;
                if (item.entity?.point) item.entity.point.color = item.isSunny ? Cesium.Color.GOLD : Cesium.Color.GRAY;
                const d = document.getElementById('venue-'+i);
                if (d) {
                    d.className = 'venue-item ' + (item.isSunny ? 'sunny' : 'shaded');
                    d.querySelector('.sun-icon').textContent = item.isSunny ? '‚òÄÔ∏è' : sunUp ? 'üå•Ô∏è' : 'üåô';
                    d.querySelector('.status-text').textContent = item.isSunny ? 'Currently sunny' : sunUp ? 'Currently shaded' : 'After dark';
                }
                item.isSunny ? sunny++ : shaded++;
            });
            document.getElementById('sunnyCount').textContent = sunny;
            document.getElementById('shadedCount').textContent = shaded;
        }

        function setTime(h) {
            if (!viewer) return;
            currentTimeHours = h;
            const now = new Date(), utcH = h - 11;
            viewer.clock.currentTime = Cesium.JulianDate.fromDate(new Date(Date.UTC(now.getFullYear(), now.getMonth(), now.getDate(), utcH, 0, 0)));
            viewer.clock.shouldAnimate = false;
            const wh = Math.floor(h), m = Math.round((h - wh) * 60), p = wh >= 12 ? 'PM' : 'AM', dh = wh > 12 ? wh - 12 : (wh === 0 ? 12 : wh);
            document.getElementById('currentTime').textContent = dh + ':' + m.toString().padStart(2,'0') + ' ' + p;
            document.getElementById('currentDate').textContent = now.toLocaleDateString('en-AU', { weekday: 'long', month: 'long', day: 'numeric' });
            document.getElementById('timeSlider').value = h;
            updateVenueSunStatus();
        }

        function setCurrentTime() {
            const now = new Date(), melb = new Date(now.toLocaleString("en-US", { timeZone: "Australia/Melbourne" }));
            setTime(Math.max(5, Math.min(21, melb.getHours() + melb.getMinutes() / 60)));
        }

        function toggleAnimation() {
            isPlaying = !isPlaying;
            const btn = document.getElementById('playBtn');
            if (isPlaying) {
                btn.textContent = '‚è∏ Pause'; btn.classList.add('active');
                let ch = parseFloat(document.getElementById('timeSlider').value);
                animationInterval = setInterval(() => { ch += 0.1; if (ch > 21) ch = 5; setTime(ch); }, 100);
            } else {
                btn.textContent = '‚ñ∂ Play Day'; btn.classList.remove('active');
                if (animationInterval) { clearInterval(animationInterval); animationInterval = null; }
            }
        }

        function toggleVenueList() { document.getElementById('venueList').classList.toggle('collapsed'); }

        let currentVenueIndex = null;
        function openVenueModal(i) {
            currentVenueIndex = i;
            const v = venues[i];
            document.getElementById('modalVenueName').textContent = v.name;
            document.getElementById('modalVenueType').textContent = v.type + ' ‚Ä¢ ' + v.outdoorType;
            document.getElementById('modalAddress').textContent = v.address || 'Address not available';
            document.getElementById('modalDescription').textContent = v.description;
            document.getElementById('modalHours').textContent = v.hours || 'Hours not available';
            const ws = document.getElementById('modalWebsite');
            if (v.website) { ws.href = v.website; ws.textContent = v.website.replace('https://','').replace('www.','').replace(/\/$/,'') + ' ‚Üí'; ws.style.display = 'inline'; }
            else ws.style.display = 'none';
            loadVenuePhotos(i);
            document.getElementById('venueModal').classList.add('active');
        }

        function closeModal() { document.getElementById('venueModal').classList.remove('active'); currentVenueIndex = null; }
        document.getElementById('venueModal').addEventListener('click', function(e) { if (e.target === this) closeModal(); });
        document.addEventListener('keydown', function(e) { if (e.key === 'Escape') closeModal(); });

        function getStoredPhotos() { try { return JSON.parse(localStorage.getItem('sunseekerPhotos') || '{}'); } catch(e) { return {}; } }
        function savePhotos(p) { try { localStorage.setItem('sunseekerPhotos', JSON.stringify(p)); } catch(e) { alert('Storage full'); } }

        function loadVenuePhotos(i) {
            const g = document.getElementById('photoGallery'), photos = getStoredPhotos(), vp = photos[i] || [];
            g.innerHTML = '';
            vp.forEach((p, pi) => {
                const d = document.createElement('div'); d.className = 'photo-item';
                d.innerHTML = '<img src="'+p+'" alt="Photo"><button class="delete-photo" onclick="deletePhoto('+i+','+pi+')">√ó</button>';
                g.appendChild(d);
            });
            const btn = document.createElement('button'); btn.className = 'photo-upload-btn';
            btn.innerHTML = '<span>+</span><small>Add Photo</small>';
            btn.onclick = () => document.getElementById('photoInput').click();
            g.appendChild(btn);
        }

        function handlePhotoUpload(e) {
            const files = e.target.files;
            if (!files.length || currentVenueIndex === null) return;
            const photos = getStoredPhotos();
            if (!photos[currentVenueIndex]) photos[currentVenueIndex] = [];
            Array.from(files).forEach(f => {
                if (f.size > 2*1024*1024) { alert('Photo too large (max 2MB)'); return; }
                const r = new FileReader();
                r.onload = function(ev) {
                    const img = new Image();
                    img.onload = function() {
                        const c = document.createElement('canvas');
                        let w = img.width, h = img.height;
                        if (w > 400 || h > 400) { if (w > h) { h = (h/w)*400; w = 400; } else { w = (w/h)*400; h = 400; } }
                        c.width = w; c.height = h;
                        c.getContext('2d').drawImage(img, 0, 0, w, h);
                        photos[currentVenueIndex].push(c.toDataURL('image/jpeg', 0.7));
                        savePhotos(photos);
                        loadVenuePhotos(currentVenueIndex);
                    };
                    img.src = ev.target.result;
                };
                r.readAsDataURL(f);
            });
            e.target.value = '';
        }

        function deletePhoto(vi, pi) {
            if (!confirm('Delete photo?')) return;
            const photos = getStoredPhotos();
            if (photos[vi]) { photos[vi].splice(pi, 1); savePhotos(photos); loadVenuePhotos(vi); }
        }

        window.onload = init;
    </script>
</body>
</html>
